# Архитектура системы «Football Ecosystem Platform» ⚽️

Проект концептуальной архитектуры мобильной платформы для организации футбольных сообществ.

## Содержание

1. [Введение](#1-введение)
    * [1.1 Актуальность проекта](#11-актуальность-проекта)
    * [1.2 Цели и задачи разработки](#12-цели-и-задачи-разработки)
    * [1.3 Предмет проектирования](#13-предмет-проектирования)
    * [1.4 Объект проектирования](#14-объект-проектирования)
2. [Анализ требований](#2-анализ-требований)
    * [2.1 Бизнес-цели проекта](#21-бизнес-цели-проекта)
    * [2.2 Стейкхолдеры и их интересы](#22-стейкхолдеры-и-их-интересы)
    * [2.3 Бизнес-требования (BR)](#23-бизнес-требования-br)
    * [2.4 Функциональные требования (FR)](#24-функциональные-требования-fr)
3. [Архитектурный анализ](#3-архитектурный-анализ)
    * [3.1 Атрибуты качества](#31-атрибуты-качества)
    * [3.2 Нефункциональные требования (NFR)](#32-нефункциональные-требования-nfr)
    * [3.3 Архитектурные опции и обоснование выбора](#33-архитектурные-опции-и-обоснование-выбора)
    * [3.4 Список архитектурных решений (ADR)](#34-список-архитектурных-решений-adr)
4. [Концептуальная архитектура (C4 Model)](#4-концептуальная-архитектура-c4-model)
    * [4.1 Уровень 1: Системный контекст](#41-уровень-1-системный-контекст)
    * [4.2 Уровень 2: Контейнеры и компоненты](#42-уровень-2-контейнеры-и-компоненты)
5. [Архитектурные представления](#5-архитектурные-представления)
    * [5.1 Функциональное и Информационное](#51-функциональное-и-информационное)
    * [5.2 Многозадачность (Concurrency)](#52-многозадачность-concurrency)
    * [5.3 Инфраструктура и Безопасность](#53-инфраструктура-и-безопасность)
6. [Реализация и сценарии](#6-реализация-и-сценарии)
    * [6.1 Описание сценариев использования (Use Cases)](#61-описание-сценариев-использования-use-cases)
    * [6.2 Критические бизнес-сценарии](#62-критические-бизнес-сценарии)
    * [6.3 План поэтапной разработки (Roadmap)](#63-план-поэтапной-разработки-roadmap)
7. [Анализ рисков и стоимость](#7-анализ-рисков-и-стоимость)
    * [7.1 Анализ рисков и компромиссов](#71-анализ-рисков-и-компромиссов)
    * [7.2 Оценка стоимости владения (TCO)](#72-оценка-стоимости-владения-tco)
8. [Заключение](#8-заключение)

---

## 1. Введение
  
### 1.1 Актуальность проекта
В условиях глобальной цифровизации спорта крупные транснациональные корпорации стремятся выйти за рамки классического ритейла, создавая полноценные цифровые экосистемы. Данный проект направлен на разработку платформы, которая не только автоматизирует организацию любительского спорта (футбола), но и формирует **самоподдерживающиеся социальные группы**. 
  
> **Глобальная бизнес-цель:** Освоить новые каналы информирования покупателей о выходе новых товаров и стимулировать вовлечённость в здоровый образ жизни через соревновательные механики.

### 1.2 Цели и задачи разработки
Основной целью работы является проектирование концептуальной архитектуры мобильного приложения, обеспечивающего:
*   **Социальное взаимодействие:** Формирование групп по интересам и поиск партнеров для тренировок;
*   **Аналитическую поддержку:** Сравнение характеристик тренировок с прошлыми результатами и показателями других игроков;
*   **Монетизацию:** Внедрение промоакций и бесшовную интеграцию с существующим интернет-магазином компании;
*   **Безопасность:** Особое внимание уделено защите персональных данных пользователей и данных о здоровье в соответствии с мировыми стандартами (ФЗ-152, GDPR).
  
### 1.3 Предмет проектирования
Предметом проектирования является архитектура и программная реализация распределенной системы на базе микросервисов и методологии DDD, обладающей высоким потенциалом горизонтального масштабирования. Система проектируется как гибкий фундамент, позволяющий бесшовно расширять географию сервиса (от локального MVP до глобального рынка) и наращивать функциональные модули маркетинговой аналитики без перепроектирования ядра.  
  
> Система должна обеспечивать высокую доступность и масштабируемость для обслуживания пользователей по всему миру.  
  
### 1.4 Объект проектирования
Цифровая экосистема взаимодействия участников любительского футбола, включающая процессы коммерческой эксплуатации спортивных объектов, организации соревновательной деятельности (лиги, турниры), мониторинга персональной физической активности и персонализированного маркетинга в синергии с интернет-магазином.
  
---
  
## 2. Анализ требований

### 2.1 Бизнес-цели проекта
На основе анализа интересов инвестора определены следующие приоритетные цели:
1. Увеличение конверсии в интернет-магазине через нативную рекламу на основе встроенной рекомендательной системы;
2. Создание самоподдерживающихся социальных групп по интересам для повышения лояльности и удержания пользователей;
3. Снижение стоимости привлечения новых пользователей за счет виральности и социального взаимодействия;
4. Формирование качественной базы данных об инвентаре и спортивных интересах пользователей для предиктивного маркетинга.
  
---
  
### 2.2 Стейкхолдеры и их интересы

Для проектирования системы были выделены ключевые группы стейкхолдеров. Понимание их интересов позволило определить границы доменов (Bounded Contexts) и приоритеты разработки.

| Стейкхолдер | Основной интерес в системе | Ключевая цель |
|:---|:---|:---|
| **Владелец площадки** | Монетизация объекта | Сдача площадки в аренду, управление слотами, привлечение новых команд. |
| **Игрок** | Персонализация и социализация | Поиск партнеров, ведение личной статистики, мониторинг здоровья. |
| **Капитан команды** | Управление и логистика | Формирование состава, поиск и аренда площадок, организация игр. |
| **Организатор матчей** | Администрирование соревнований | Создание турнирных сеток, управление расписанием, фиксация результатов. |
| **Маркетолог/Инвестор** | Нативная реклама и продажи | Рост конверсии в интернет-магазине через анализ данных об инвентаре и интересах. |
| **Администратор** | Безопасность и контроль | Модерация контента, управление политиками приватности, аудит действий. |

Для ознакомления с расширенным анализом итересов стейхолдеров перейдите по [ссылке](./03-stakeholder-interests.md)

---

### 2.3 Бизнес-требования (BR)

Ниже приведен консолидированный список высокоуровневых бизнес-требований, сгруппированных по ключевым направлениям.

| ID | Категория | Описание требования |
|:---|:---|:---|
| **BR-01** | **Аренда** | Предоставить владельцам ФП инструменты публикации площадок и управления стоимостью слотов. |
| **BR-02** | **Организация** | Позволить капитанам и игрокам искать, бронировать и отменять аренду слотов в реальном времени. |
| **BR-03** | **Профиль** | Обеспечить сбор данных об экипировке, интересах и физических показателях (через смарт-часы). |
| **BR-04** | **Социум** | Создать механизмы формирования команд, поиска партнеров и подписок на активности. |
| **BR-05** | **Турниры** | Предоставить организаторам функционал по созданию турнирных сеток и фиксации результатов. |
| **BR-06** | **Маркетинг** | Реализовать движок нативной рекламы и бесшовный переход (SSO) в интернет-магазин инвестора. |
| **BR-07** | **Безопасность**| Гарантировать сохранность данных о здоровье и аудит действий с персональными данными. |

---

### 2.4 Функциональные требования (FR)

Функциональные требования описывают поведение системы для реализации указанных выше BR.  
> Трассировка гарантирует, что каждая функция обоснована бизнес-целью.

| ID ФТ | Компонент | Функциональное требование | Трассировка |
|:---|:---|:---|:---|
| **FR-BK-01** | Booking | CRUD-интерфейс управления карточкой площадки и фото. | BR-01 |
| **FR-BK-02** | Booking | Транзакционный механизм бронирования (защита от Double Booking). | BR-02, BR-07 |
| **FR-UP-01** | Profile | Анкета игрока: инвентарь, бренды, навыки и хобби. | BR-03 |
| **FR-UP-02** | Profile | Интеграция с Apple Health / Google Fit для импорта тренировок. | BR-03 |
| **FR-TM-01** | Teams | Создание карточки команды и управление ростером (инвайты/кики). | BR-04 |
| **FR-TR-01** | Tournaments| Генератор сеток (Play-off/Round Robin) и протоколы матчей. | BR-05 |
| **FR-AD-01** | Ads | Генерация Deep Links с SSO-токеном для перехода в магазин. | BR-06 |
| **FR-NT-01** | Notification| Рассылка PUSH-уведомлений о бронях и успехах друзей. | BR-02, BR-04 |
| **FR-ADM-01**| Admin | Инструменты модерации контента и конфигурация лимитов отмены. | BR-07 |

---

## 3. Архитектурный анализ

### 3.1 Атрибуты качества

Для обеспечения долгосрочной жизнеспособности платформы и удовлетворения интересов инвестора были выделены три приоритетных атрибута качества:

1. **Согласованность (Consistency):** 
   * *Область:* Модуль бронирования и финансовых операций.
   * *Требование:* Исключение двойных продаж (Double Booking) и гарантия целостности данных при конкурентном доступе.
2. **Доступность (Availability):** 
   * *Область:* Мобильное приложение для пользователей.
   * *Требование:* Система должна быть доступна 24/7 (SLA 99.9%), так как пользователи принимают решения о тренировках спонтанно.
3. **Модифицируемость (Modifiability):** 
   * *Область:* Функциональное расширение (MVP -> Соцсеть -> Аналитика).
   * *Требование:* Архитектура должна позволять внедрять новые модули (например, "Турниры") без переписывания существующих сервисов.

---

### 3.2 Нефункциональные требования (NFR)
* **Производительность:** Время отклика API Gateway (p95) < 200 мс.
* **Надежность:** Коэффициент доступности системы (SLA) 99.9%.
* **Емкость:** Поддержка до 100 000 одновременно активных соединений (WebSockets) для пушей.
* **Compliance:** Соответствие ФЗ-152 и GDPR в части хранения ПД.

---

### 3.3 Архитектурные опции и обоснование выбора

При выборе архитектурного стиля проводилось сравнение монолитного и микросервисного подходов.

| Критерий | Монолитная архитектура | Микросервисная архитектура (DDD) |
|:---|:---|:---|
| **Скорость старта** | Высокая (быстрая разработка MVP) | Средняя (требует настройки CI/CD и Kafka) |
| **Масштабируемость** | Вертикальная (ограничена) | **Горизонтальная (независимая для каждого сервиса)** |
| **Отказоустойчивость** | Низкая (падение модуля валит всё приложение) | **Высокая (изоляция отказов в рамках сервиса)** |
| **Сложность данных** | Одна БД (риск "спагетти-связей") | **Polyglot Persistence (своя БД под каждый домен)** |

**Обоснование выбора:**
Для реализации проекта выбрана **микросервисная архитектура на базе Domain-Driven Design (DDD)**. 
Это решение продиктовано:
* Необходимостью независимого развития домена «Маркетинг» (Ads Service) и домена «Бронирование» (Booking Service).
* Требованием масштабируемости под глобальный рынок.
* Возможностью использовать Kafka для асинхронного взаимодействия, что повышает общую надежность системы.

---

## 3.4 Список архитектурных решений (ADR)

В данном разделе зафиксированы ключевые проектные решения, определившие облик системы. Каждое решение принято на основе анализа бизнес-целей и атрибутов качества.

| ID | Решение | Контекст и Обоснование |
|:---|:---|:---|
| **ADR-01** | **Микросервисная архитектура (DDD)** | Необходимость независимого масштабирования доменов (Бронирование vs Аналитика) и работа разных команд над модулями. |
| **ADR-02** | **Event-Driven взаимодействие (Kafka)** | Требование слабой связности (Decoupling) между сервисом бронирования и системой контекстной рекламы. |
| **ADR-03** | **Pessimistic Locking (PostgreSQL)** | Риск Double Booking (BR-SYS-01). Требуется строгая транзакционность на уровне БД для исключения конфликтов. |
| **ADR-04** | **JWT + Deep Linking (SSO)** | Требование инвестора о бесшовном переходе в основной магазин. Передача Short-lived токенов обеспечивает безопасность и UX. |

---

#### Детальное описание ключевого решения (Пример ADR-01)

> **Заголовок:** Переход на микросервисную архитектуру по принципам DDD.
>
> **Контекст:** Система объединяет в себе высоконагруженное бронирование (OLTP) и тяжелую аналитику для нативной рекламы (OLAP). Монолитная архитектура создаст риски при масштабировании и затруднит внедрение новых социальных функций.
>
> **Решение:** Разделить систему на 7 функциональных доменов (Bounded Contexts), каждый из которых владеет собственной базой данных.
>
> **Последствия:**
> *   **Положительные:** Независимый деплой, изоляция отказов, возможность выбора оптимальной БД для каждого домена.
> *   **Отрицательные:** Усложнение инфраструктуры, необходимость контроля распределенной согласованности (Sagas).

---

## 4. Концептуальная архитектура (C4 Model)

Для проектирования системы использована методология **C4 Model**, позволяющая декомпозировать архитектуру от бизнес-контекста до конкретных технологических контейнеров.

### 4.1 Уровень 1: Системный контекст

На данном уровне показано взаимодействие системы «Football Ecosystem» с внешними пользователями и окружением компании.

![System Context Diagram](./diagrams/context-level-1.png)

**Ключевые взаимодействия:**
*   **Стейкхолдеры:** Взаимодействуют с системой через единое мобильное приложение.
*   **Магазин инвестора:** Принимает пользователей через Deep Links для совершения покупок.
*   **Фитнес-сервисы (Apple/Google):** Поставляют данные о физической активности.
*   **Уведомления (FCM/Email):** Внешние шлюзы для доставки сообщений пользователям.

---

### 4.2 Уровень 2: Контейнеры и компоненты

Здесь раскрывается внутренняя структура системы: распределение логики по микросервисам и выбор хранилищ данных.

![Container Diagram](./diagrams/container-level-2.png)

**Технологический стек и интеграция:**
*   **API Gateway (Kong):** Единая точка входа, обеспечивающая безопасность и маршрутизацию.
*   **Message Broker (Apache Kafka):** Шина событий для асинхронного взаимодействия (например, передача данных из *Profile* в *Ads*).
*   **Database per Service:** 
    *   **PostgreSQL:** Транзакционные данные (Booking, Tournaments).
    *   **MongoDB:** Социальные связи и гибкие профили (Teams, Profile).
    *   **ClickHouse:** Аналитика и рекламные метрики (Ads).
*   **Identity Service:** Централизованная аутентификация и генерация SSO-токенов.

---

## 5. Архитектурные представления

### 5.1 Функциональное и Информационное
Данное представление описывает логическую структуру системы и стратегию управления данными.

*   **Декомпозиция:** Система разделена на 7 микросервисов на базе бизнес-доменов. API Gateway (Kong) изолирует внутреннюю сеть и управляет сквозной авторизацией.
*   **Стратегия данных (Polyglot Persistence):**
    *   **PostgreSQL:** Используется в сервисах *Booking* и *Tournaments* для обеспечения ACID-свойств в критических операциях.
    *   **MongoDB:** Выбрана для сервисов *Profile* и *Teams* благодаря гибкости схемы данных (Social Graph, инвентарь).
    *   **ClickHouse:** Применяется в *Ads Service* для высокоскоростной обработки логов и аналитики рекламных переходов.

---

### 5.2 Многозадачность (Concurrency)
Описание механизмов обработки параллельных запросов и обеспечения целостности.

*   **Конкурентный доступ:** Для предотвращения Double Booking в домене *Booking* реализован механизм **Pessimistic Locking** на уровне строк базы данных.
*   **Асинхронность:** Тяжелые процессы (рассылка уведомлений, расчет статистики, агрегация данных для рекламы) вынесены в фоновые задачи через **Apache Kafka**. Это гарантирует, что задержки внешних систем (например, Apple Health) не влияют на отзывчивость UI.
*   **Масштабирование:** Каждый контейнер микросервиса является stateless, что позволяет горизонтально масштабировать систему под нагрузкой.

---

### 5.3 Инфраструктура и Безопасность
Описание физического развертывания и защиты системы.

*   **Deployment:** 
    *   Среда: Облачная инфраструктура (Cloud-native).
    *   Оркестрация: **Kubernetes (K8s)** для управления контейнерами.
    *   CI/CD: Автоматизированные пайплайны сборки и деплоя для каждого сервиса.
*   **Security Model:**
    *   **Identity:** Использование стандарта **OAuth 2.0 / OpenID Connect**.
    *   **Traffic:** Весь обмен данными защищен **TLS 1.3**.
    *   **Data Protection:** Персональные данные и показатели здоровья шифруются алгоритмом **AES-256**.
    *   **SSO (Deep Links):** Реализована безопасная передача кратковременных токенов доступа для бесшовного перехода в магазин инвестора.


Архитектурный вывод: Выбранная микросервисная модель в сочетании с Kafka напрямую адресует атрибут модифицируемости (через слабую связность), а использование PostgreSQL с блокировками гарантирует атрибут согласованности в критических бизнес-сценариях.

---

## 6. Реализация и сценарии

### 6.1 Описание сценариев использования (Use Cases)

Ниже приведены сценарии использования, описывающие сквозное взаимодействие функциональных блоков системы (микросервисов) через синхронные вызовы и шину событий Kafka.

#### **UC-1: Организация открытого матча капитаном**
Сценарий описывает процесс бронирования и автоматического сбора состава.
*   **Действие:** 
    1. Капитан ищет и резервирует свободный слот через **Booking Service**.
    2. При подтверждении брони выбирает опцию «Открытая игра» в **Team Service**.
    3. **Team Service** публикует событие `MatchCreated` в **Kafka**.
    4. **Notification Service** считывает событие и рассылает PUSH-уведомления подходящим игрокам в регионе.
*   **Результат:** Площадка забронирована, целевая аудитория оповещена о наборе в состав.

#### **UC-2: Персонализированное предложение (Маркетинг)**
Сценарий реализации интереса инвестора через анализ профиля.
*   **Действие:** 
    1. Игрок указывает в профиле интерес к бренду или инвентарю (**Profile Service**).
    2. **Ads Service** фиксирует интерес и сопоставляет его с активными офферами маркетолога.
    3. При следующем запуске приложения **Ads Service** генерирует динамический баннер с Deep Link.
    4. Клик по ссылке инициирует запрос к **Identity Service** для создания SSO-токена.
    5. Пользователь бесшовно переходит в корзину магазина инвестора с примененным промокодом.
*   **Результат:** Нативная продажа товара на основе актуальных данных игрока.

#### **UC-3: Проведение и автоматизация турнира**
Сценарий работы организатора соревнований.
*   **Действие:** 
    1. Организатор создает турнир и сетку в **Tournament Service**.
    2. Команды подают заявки, проходя валидацию ростера в **Team Service**.
    3. По завершении матчей организатор вносит счет; **Tournament Service** автоматически обновляет сетку.
    4. Система через **Kafka** и **Notification Service** уведомляет следующих участников о времени и месте их матча.
*   **Результат:** Полная автоматизация турнирного цикла и информирование участников.

---

### 6.2 Критические бизнес-сценарии
Ниже описаны ключевые цепочки взаимодействий, которые определяют успех платформы.

1. **UC-1: Организация матча и сбор состава.**
   * *Процесс:* Капитан бронирует слот (**Booking Service**) → Создает открытую игру (**Team Service**) → Событие уходит в **Kafka** → **Notification Service** рассылает Push-уведомления подходящим игрокам в радиусе 5 км.
   * *Результат:* Гарантированное заполнение слота и социальная активность.

2. **UC-2: Персонализированное предложение и покупка.**
   * *Процесс:* Игрок импортирует данные о 100 км бега (**Profile Service**) → **Ads Service** анализирует износ инвентаря → В ленте появляется баннер со ссылкой на новую модель кроссовок → Игрок переходит по **Deep Link** в магазин инвестора с предустановленной скидкой.
   * *Результат:* Выполнение KPI инвестора по бесшовным продажам.

3. **UC-3: Проведение крупного турнира.**
   * *Процесс:* Организатор создает сетку на 32 команды (**Tournament Service**) → Система резервирует необходимые слоты на площадках (**Booking Service**) → Результаты матчей обновляются в реальном времени, формируя лидерборды.

---

### 6.3 План поэтапной разработки (Roadmap)

Для минимизации рисков проект разделен на три фазы:

#### **Фаза 1: Основа (MVP)**
* **Цель:** Запуск основного цикла аренды.
* **Сервисы:** `Auth`, `Booking`, `Profile` (Core).
* **Результат:** Возможность найти и забронировать поле.

#### **Фаза 2: Экосистема и Монетизация**
* **Цель:** Подключение аналитики и рекламного движка.
* **Сервисы:** `Ads Service`, `Social/Team`, Интеграция с Kafka.
* **Результат:** Нативная реклама и формирование команд.

#### **Фаза 3: Масштабирование**
* **Цель:** Глобальный запуск и турниры.
* **Сервисы:** `Tournament Service`, `Admin/Moderation`, Аналитическое хранилище.
* **Результат:** Полноценная спортивная соцсеть.

---

## 7. Анализ рисков и стоимость

### 7.1 Анализ рисков и компромиссов

Принятые архитектурные решения сопровождаются анализом потенциальных рисков и осознанными технологическими компромиссами (Trade-offs).

| Тип риска | Описание | Стратегия минимизации (Mitigation) |
|:---|:---|:---|
| **Технический** | **Data Consistency:** Риск рассогласованности данных в распределенной среде. | Использование паттерна Saga для сложных операций и Outbox Pattern для Kafka. |
| **Технический** | **Operational Complexity:** Сложность управления 7+ базами данных и брокером. | Контейнеризация (Docker) и использование управляемых облачных сервисов (Managed Services). |
| **Бизнес** | **Privacy Compliance:** Риск нарушения ФЗ-152 при хранении данных о здоровье. | Шифрование чувствительных данных (AES-256) и строгий аудит доступа. |
| **Бизнес** | **User Adoption:** Низкое заполнение профилей игроками. | Геймификация и предоставление эксклюзивных скидок за подключение фитнес-трекеров. |

---

### 7.2 Оценка стоимости владения (TCO)

Прогноз совокупной стоимости владения инфраструктурой при масштабировании системы.

| Период | Нагрузка (Users) | Инфраструктурные компоненты | Прогноз затрат |
|:---|:---|:---|:---|
| **Год 1 (MVP)** | до 10 000 | Базовые инстансы БД, API Gateway, Single Kafka node. | Минимальные (от $300/мес) |
| **Год 2 (Рост)** | до 100 000 | Кластеры K8s, репликация БД, расширенное S3 хранилище. | Средние (от $1200/мес) |
| **Год 5 (Пик)** | 1 000 000+ | Auto-scaling, ClickHouse Cluster, гео-распределенные узлы. | Enterprise (от $4500/мес) |

---

## 8. Заключение

Разработанная концептуальная архитектура системы **«Football Ecosystem»** полностью соответствует заявленным бизнес-целям транснациональной компании. Применение принципов **Domain-Driven Design** и микросервисного подхода позволило:
1. Изолировать критический домен бронирования от аналитических модулей монетизации.
2. Обеспечить бесшовный пользовательский опыт, связывающий спорт и ритейл.
3. Заложить фундамент для глобального масштабирования социальной платформы.

Система готова к поэтапной реализации, начиная с MVP-модуля аренды спортивных площадок.









